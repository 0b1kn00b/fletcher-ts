"use strict";var J=Object.defineProperty;var k=(i,e,t)=>e in i?J(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var f=(i,e,t)=>(k(i,typeof e!="symbol"?e+"":e,t),t);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});var z=function(){function i(){var e=this;this.resolve=function(t){e._resolve(t)},this.reject=function(t){e._reject(t)},this._promise=new Promise(function(t,r){e._resolve=t,e._reject=r})}return Object.defineProperty(i.prototype,"promise",{get:function(){return this._promise},enumerable:!0,configurable:!0}),i}(),g=z,D=function(i){return i._tag==="Left"},$=function(i){return{_tag:"Left",left:i}},O=function(i){return{_tag:"Right",right:i}},F=$,U=O,R=D,Z=function(i,e){return function(t){return R(t)?i(t.left):e(t.right)}},j=Z,L=j;class l{constructor(e){f(this,"_after",null);this._after=e}get after(){return this._after==null?null:this._after()}static Seq(e,t){return new l(()=>{let r=e==null?void 0:e.after;return r!=null?new Promise(n=>r.then(s=>l.Seq(s,t)).then(n)):t==null?void 0:t.after})}seq(e){return l.Par(this,e)}par(e){return l.Par(this,e)}submit(){return l.Submit(this)}static Submit(e){let t=new g;return setTimeout(()=>{if(e!=null){const r=e.after;r!=null?r.then(n=>{n!=null?l.Submit(n).then(s=>t.resolve(s),s=>t.reject(s)):t.resolve(null)}):t.resolve(null)}else t.resolve(null)}),t.promise}static Par(e,t){let r=e.after??Promise.resolve(l.Unit()),n=t.after??Promise.resolve(l.Unit()),s=Promise.all([r,n]);return l.Pure(s.then(([a,o])=>a!=null&&o!=null?l.Par(a,o):a??o))}static Unit(){return new l(null)}static Pure(e){return new l(()=>e)}}class w{constructor(e){f(this,"_apply");this._apply=e}apply(e){return this._apply(e)}}class N extends w{}class M extends N{}class v extends M{flat_fold(e,t){return new v(r=>this.apply(new w(n=>{let a=n.then(p=>j(e,t)(p)).then(p=>p.apply(r));return new l(()=>a)})))}handler(e,t){return j(r=>e(r),r=>{if(t)t(r);else throw t})}zip(e){return v.Zip(this,e)}static Zip(e,t){return new v(r=>{var n=null,s=null;let a=e.apply(new w(p=>(n=p,l.Unit())));var o=t.apply(new w(p=>(s=p,l.Unit())));return a.par(o).seq(new l(()=>{let p=n,S=s,B=p.then(y=>S.then(m=>({fst:y,snd:m}))).then(y=>L(m=>L(b=>F([m,b]),b=>U(b))(y.snd),m=>U(m))(y.fst)),E=r.apply(B);return new Promise(y=>y(E))}))})}}class c extends M{receive(e){return e.apply(new w(t=>this.apply(new w(r=>{let n=t.then(s=>{r.resolve(s)});return new l(()=>n.then(s=>l.Unit()))}))))}static later(e){return new v(t=>t.apply(e))}static issue(e){return new v(function(t){let r=new Promise(n=>{n(e)});return t.apply(r)})}static value(e){return c.issue(F(e))}static error(e){return c.issue(U(e))}static Pure(e){return new c(t=>t.apply(e))}}class P{constructor(e){f(this,"_apply");this._apply=e}defer(e,t){return t.receive(c.value(this._apply(e)))}}class x{constructor(e){f(this,"_defer");this._defer=e}defer(e,t){return this._defer(e,t)}}function d(i,e){return new v(t=>{let r=new g,n=i.defer(e,new c(a=>a.apply(r))),s=t.apply(r.promise);return l.Seq(n,s)})}function q(i,e){let t=new g;return i.defer(e,c.Pure(t)).submit().then(()=>t.promise.then(s=>s))}function W(){return new P(i=>null)}class G{constructor(e){f(this,"_emiter");this._emiter=e}defer(e,t){let r=new g,n=this,s={handleEvent:function(a){r.resolve(F(a)),n._emiter.removeEventListener(e,s)}};return this._emiter.addEventListener(e,s),t.receive(c.later(r.promise))}}class H{constructor(e,t){f(this,"lhs");f(this,"rhs");this.lhs=e,this.rhs=t}defer(e,t){var r=d(this.lhs,e);return t.receive(r.flat_fold(n=>d(this.rhs,n),n=>c.error(n)))}}class T extends P{constructor(){super(e=>e)}}class u{constructor(e){f(this,"_apply");this._apply=e}apply(e){return this._apply(e)}next(e){return new u(t=>{let r=this.apply(t);return e.apply(r)})}static Make(e){return new u(e)}static Unit(){return new u(e=>e)}static Pure(e){return new u(t=>e)}static Then(e){return new u(t=>new H(t,e))}then(e){return this.next(u.Then(e))}static Pair(e){return new u(t=>new x((r,n)=>{let[s,a]=r,o=d(t,s),p=d(e,a);return n.receive(o.zip(p))}))}pair(e){return this.next(u.Pair(e))}static Split(e){return new u(t=>new x((r,n)=>u.Pair(e).apply(t).defer([r,r],n)))}split(e){return this.next(u.Split(e))}static FlatMap(e){return new u(t=>new x((r,n)=>n.receive(d(t,r).flat_fold(s=>d(e(s),r),s=>c.error(s)))))}flat_map(e){return this.next(u.FlatMap(e))}static First(){return new u(e=>{let t=u.Pure(new P(n=>n));return u.Pair(t.apply(e)).apply(e)})}first(){return this.next(u.First())}static Second(){return new u(e=>{let t=u.Pure(new P(n=>n));return u.Pair(e).apply(t.apply(e))})}second(){return this.next(u.Second())}static Pinch(e){return new u(t=>new x((r,n)=>n.receive(d(t,r).zip(d(e,r)))))}pinch(e){return this.next(u.Pinch(e))}static Joint(e){return new u(t=>u.Then(u.Pure(u.Split(e).apply(new T)).apply(new T)).apply(t))}joint(e){return this.next(u.Joint(e))}static Bound(e){return new u(t=>{let r=new T,n=u.Then(e),s=u.Joint(t).apply(r);return n.apply(s)})}bound(e){return this.next(u.Bound(e))}static Broach(){return new u(e=>{let t=new P(r=>r);return u.Bound(t).apply(e)})}broach(){return this.next(u.Broach())}resolve(e){return q(this.apply(W()),e)}static Compose(e,t){return t.next(e)}compose(e){return u.Compose(this,e)}}class h{static Terminal(){return new c(e=>e.apply(new g))}static Arrow(){return u}static Fun1R(e){return new P(e)}static Pure(e){return h.Fun1R(t=>e)}static Anon(e){return new x(e)}static Resolve(e,t){return q(e,t)}static Forward(e,t){return d(e,t)}static Event(e){return new G(e)}static Then(e){return h.Arrow().Then(e)}static Pair(e){return h.Arrow().Pair(e)}static FlatMap(e){return h.Arrow().FlatMap(e)}static First(){return h.Arrow().First()}static Second(){return h.Arrow().Second()}static Pinch(e){return h.Arrow().Pinch(e)}static Joint(e){return h.Arrow().Joint(e)}static Next(e,t){return e.next(t)}}exports.Fletcher=h;
